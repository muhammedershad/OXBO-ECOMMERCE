<%- include('./partials/header.ejs') %>

<div class="container mt-4">
  <div class="row">
    <div class="col-md-3">
      <div class="list-group">
        <a href="#" class="list-group-item list-group-item-action active"
          >User Menu</a
        >
        <a href="#" class="list-group-item list-group-item-action"
          >User Profile</a
        >
        <a href="#" class="list-group-item list-group-item-action">My Info</a>
        <a href="/orderList" class="list-group-item list-group-item-action">My Orders</a>
        <a href="#" class="list-group-item list-group-item-action">Wishlist</a>
        <a href="#" class="list-group-item list-group-item-action">Logout</a>
      </div>
    </div>
    <div class="col-md-9">
        <div class="container mt-2">
            <h2>Address Form</h2>
            <form id="addressForm">
                <div class="form-group mb-2">
                    <label class="required-label" for="name">Name</label>
                    <input type="text" class="form-control" id="name" name="name" required>
                </div>
                <div class="form-group mb-2">
                    <label for="address">Address:</label>
                    <input type="text" class="form-control" id="address" name="address" required>
                </div>
                <div class="form-group mb-2">
                    <label for="city">City/Town:</label>
                    <input type="text" class="form-control" id="city" name="city" required>
                </div>
                <div class="form-group mb-2">
                    <label for="state">State:</label>
                    <input type="text" class="form-control" id="state" name="state" required>
                </div>
                <div class="form-group mb-2">
                    <label for="country">Country:</label>
                    <input type="text" class="form-control" id="country" name="country" required>
                </div>
                <div class="form-group mb-2">
                    <label for="pincode">Pincode:</label>
                    <input type="text" class="form-control" id="pincode" name="pincode" required>
                </div>
                <div class="form-group mb-2">
                    <label for="altNumber">Alternative Number:</label>
                    <input type="number" class="form-control" id="altNumber" name="altNumber">
                </div>
                <button type="submit" class="btn btn-primary mb-2">Submit</button>
            </form>
        </div>
    
    </div>
    
  </div>
</div>

<script>
    document.getElementById('addressForm').addEventListener('submit', function(event) {
        let isValid = true;

        const inputs = document.querySelectorAll('#addressForm input[required]');
        inputs.forEach(input => {
            if (!input.value) {
                isValid = false;
                input.classList.add('is-invalid');
            } else {
                input.classList.remove('is-invalid');
            }
        });

        if (!isValid) {
            event.preventDefault();
        }
    });
</script>

<%- include('./partials/footer.ejs') %>






<%- include('./partials/header.ejs') %>
<% let subtotalPrice = 0 %>
<% user.cart.forEach(product => { %>
    <input type="number" hidden <%= subtotalPrice += (product.product.MRP * product.quantity) %>>
<% }) %>
<% let totalPrice = subtotalPrice + 40 - couponAmount %>

<section class=" my-5 d-flex justify-self-center">
    <div class="container ">
      <div class="row d-flex justify-content-center">
        <!-- cart -->
        <div class="col-lg-7 d-flex justify-content-center">
          <div class="card border shadow-1">
            <div class="m-4">
              
              <% if (user.address.length !== 0) { %>
                <div class="row p-0 m-0 ">
                  <% if (user.cart.length === 0) { %>
                      <div class="container-fluid col-10 d-flex">
                        <h3>Your Shopping cart is empty!</h3>
                      </div>
                  <% } else { %>
                      <div class="col-10 p-0">
                          <h5 class="card-title mb-4 ">Select your address</h5>
                      </div>
                      <div class="col-2 d-flex justify-content-end p-0">
                          <!-- <button  class="btn btn-sm m-0 d-flex justify-content-center align-items-center"></button> -->
                          <button style="height: 30px; width: 110px;" type="button" class="btn btn-sm m-0 d-flex justify-content-center align-items-center" data-bs-toggle="modal" data-bs-target="#exampleModal">
                              Add address
                          </button>
                      </div>
  
                      <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                          <div class="modal-dialog">
                            <div class="modal-content">
                              <div class="modal-header">
                                <h1 class="modal-title fs-5" id="exampleModalLabel">Add New Address</h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                              </div>
                              <form id="addressForm" method="post" action="/addAddress">
                                  <div class="modal-body">
                                  
                                      <div class="form-group mb-2">
                                          <!-- <label class="required-label" for="name">Name</label> -->
                                          <input type="text" class="form-control" id="name" name="name" required placeholder="Name">
                                      </div>
                                      <div class="form-group mb-2">
                                          <!-- <label for="address">Address:</label> -->
                                          <input type="text" class="form-control" id="address" name="address" required placeholder="Address">
                                      </div>
                                      <div class="form-group mb-2">
                                          <!-- <label for="city">City/Town:</label> -->
                                          <input type="text" class="form-control" id="city" name="city" required placeholder="City/Town">
                                      </div>
                                      <div class="form-group mb-2">
                                          <!-- <label for="state">State:</label> -->
                                          <input type="text" class="form-control" id="state" name="state" required placeholder="State">
                                      </div>
                                      <div class="form-group mb-2">
                                          <!-- <label for="country">Country:</label> -->
                                          <input type="text" class="form-control" id="country" name="country" required placeholder="Country">
                                      </div>
                                      <div class="form-group mb-2">
                                          <!-- <label for="pincode">Pincode:</label> -->
                                          <input type="text" class="form-control" id="pincode" name="pincode" required placeholder="Pincode">
                                      </div>
                                      <div class="form-group mb-2">
                                          <!-- <label for="altNumber">Mobile Number:</label> -->
                                          <input type="number" class="form-control" id="altNumber" name="mobileNumber" placeholder="Mobile Number">
                                      </div>
                                      <!-- <button type="submit" class="btn btn-primary mb-2">Submit</button> -->
                                  </div>
                                  <div class="modal-footer">
                                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                  <button type="submit" class="btn ">Add address</button>
                                  </div>
                              </form>
                              
                            </div>
                          </div>
                        </div>
                      <!-- Render the cart items here -->
                  <% } %>
                    
                </div>
  
                <div class="row">
                  <h6 class="mb-3">Default Address</h6>
                  <% if (user.address[0]) { %>
                      <div class="col-md-12 mb-3">
                          <div class="card h-100" style="" data-index="<%= 0 %>">
                            <div class="form-check">
                              <input class="form-check-input d-flex mx-1 mt-4" type="radio" name="selectedAddress" value="<%= 0 %>" id="address<%= 0 %>" >
                              <div class="card-body mx-3">
                              
                                <h5 class="card-title"><%= user.address[0].name%></h5>
                                <h6 class="card-subtitle mb-2 text-body-secondary"><%= user.address[0].mobileNumber %></h6>
                                <p class="card-text"><%= user.address[0].address %>, <%= user.address[0].city %>, <%= user.address[0].state %>, <%= user.address[0].country %>, <%= user.address[0].pincode %></p>
                                <a href="#" data-bs-toggle="modal" data-bs-target="#editAddressModal<%= user.address[0]._id %>" class="btn2 card-link">Edit</a>
                                <a href="#" onclick="deleteAddress('<%= user._id %>','<%= 0 %>')" class="btn2 card-link">Delete</a>
                                <!-- <a href="#" class="btn2 card-link">Set as default</a> -->
    
                                <div class="modal fade" id="editAddressModal<%= user.address[0]._id %>" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                    <div class="modal-dialog">
                                      <div class="modal-content">
                                        <div class="modal-header">
                                          <h1 class="modal-title fs-5" id="exampleModalLabel">Edit Address</h1>
                                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <form id="addressForm" method="post" action="/editAddress?userId=<%= user._id %>&index=<%= 0 %>">
                                            <div class="modal-body">
                                            
                                                <div class="form-group mb-2">
                                                    <!-- <label class="required-label" for="name">Name</label> -->
                                                    <input type="text" class="form-control" id="name" name="name" required placeholder="Name" value="<%= user.address[0].name %>">
                                                </div>
                                                <div class="form-group mb-2">
                                                    <!-- <label for="address">Address:</label> -->
                                                    <input type="text" class="form-control" id="address" name="address" required placeholder="Address" value="<%= user.address[0].address %>">
                                                </div>
                                                <div class="form-group mb-2">
                                                    <!-- <label for="city">City/Town:</label> -->
                                                    <input type="text" class="form-control" id="city" name="city" required placeholder="City/Town" value="<%= user.address[0].city %>">
                                                </div>
                                                <div class="form-group mb-2">
                                                    <!-- <label for="state">State:</label> -->
                                                    <input type="text" class="form-control" id="state" name="state" required placeholder="State" value="<%= user.address[0].state %>">
                                                </div>
                                                <div class="form-group mb-2">
                                                    <!-- <label for="country">Country:</label> -->
                                                    <input type="text" class="form-control" id="country" name="country" required placeholder="Country" value="<%= user.address[0].country %>">
                                                </div>
                                                <div class="form-group mb-2">
                                                    <!-- <label for="pincode">Pincode:</label> -->
                                                    <input type="text" class="form-control" id="pincode" name="pincode" required placeholder="Pincode" value="<%= user.address[0].pincode %>">
                                                </div>
                                                <div class="form-group mb-2">
                                                    <!-- <label for="altNumber">Mobile Number:</label> -->
                                                    <input type="number" class="form-control" id="altNumber" name="mobileNumber" placeholder="Mobile Number" value="<%= user.address[0].mobileNumber %>">
                                                </div>
                                                <!-- <button type="submit" class="btn btn-primary mb-2">Submit</button> -->
                                            </div>
                                            <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                            <button type="submit" class="btn ">Edit address</button>
                                            </div>
                                        </form>
                                        
                                      </div>
                                    </div>
                                  </div>
    
                              </div>
                            </div>
                            
                            
                          </div>
                        </div>
                  <% } else { %>
                    
                  <% } %>
  
                  <h6 class="mb-3">Other Address</h6>
                    <% for( let index = 1; index < user.address.length; index++ ) { %>
                      <div class="col-md-12 mb-2">
                          <div class="card h-100" style="" data-index="<%= index %>">
                            <div class="form-check">
                              <input class="form-check-input d-flex mx-1 mt-4" type="radio" name="selectedAddress" value="<%= index %>" id="address<%= index %>" >
                              <div class="form-check-label card-body mx-3" for="address<%= index %>">
                                <h5 class="card-title"><%= user.address[index].name%></h5>
                                <h6 class="card-subtitle mb-2 text-body-secondary"><%= user.address[index].mobileNumber %></h6>
                                <p class="card-text"><%= user.address[index].address %>, <%= user.address[index].city %>, <%= user.address[index].state %>, <%= user.address[index].country %>, <%= user.address[index].pincode %></p>
                                <a href="#" data-bs-toggle="modal" data-bs-target="#editAddressModal<%= user.address[index]._id %>" class="btn2 card-link">Edit</a>
                                <!-- <button class="btn2 card-link">Edit</button> -->
                                <a href="#" onclick="deleteAddress('<%= user._id %>','<%= index %>')" class="btn2 card-link">Delete</a>
                                <a href="#" onclick="makeDefaultAddress('<%= user._id %>','<%= index %>')" class="btn2 card-link">Set as default</a>
    
                                <div class="modal fade" id="editAddressModal<%= user.address[index]._id %>" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                    <div class="modal-dialog">
                                      <div class="modal-content">
                                        <div class="modal-header">
                                          <h1 class="modal-title fs-5" id="exampleModalLabel">Edit Address</h1>
                                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <form id="addressForm" method="post" action="/editAddress?userId=<%= user._id %>&index=<%= index %>">
                                            <div class="modal-body">
                                            
                                                <div class="form-group mb-2">
                                                    <!-- <label class="required-label" for="name">Name</label> -->
                                                    <input type="text" class="form-control" id="name" name="name" required placeholder="Name" value="<%= user.address[index].name %>">
                                                </div>
                                                <div class="form-group mb-2">
                                                    <!-- <label for="address">Address:</label> -->
                                                    <input type="text" class="form-control" id="address" name="address" required placeholder="Address" value="<%= user.address[index].address %>">
                                                </div>
                                                <div class="form-group mb-2">
                                                    <!-- <label for="city">City/Town:</label> -->
                                                    <input type="text" class="form-control" id="city" name="city" required placeholder="City/Town" value="<%= user.address[index].city %>">
                                                </div>
                                                <div class="form-group mb-2">
                                                    <!-- <label for="state">State:</label> -->
                                                    <input type="text" class="form-control" id="state" name="state" required placeholder="State" value="<%= user.address[index].state %>">
                                                </div>
                                                <div class="form-group mb-2">
                                                    <!-- <label for="country">Country:</label> -->
                                                    <input type="text" class="form-control" id="country" name="country" required placeholder="Country" value="<%= user.address[index].country %>">
                                                </div>
                                                <div class="form-group mb-2">
                                                    <!-- <label for="pincode">Pincode:</label> -->
                                                    <input type="text" class="form-control" id="pincode" name="pincode" required placeholder="Pincode" value="<%= user.address[index].pincode %>">
                                                </div>
                                                <div class="form-group mb-2">
                                                    <!-- <label for="altNumber">Mobile Number:</label> -->
                                                    <input type="number" class="form-control" id="altNumber" name="mobileNumber" placeholder="Mobile Number" value="<%= user.address[index].mobileNumber %>">
                                                </div>
                                                <!-- <button type="submit" class="btn btn-primary mb-2">Submit</button> -->
                                            </div>
                                            <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                            <button type="submit" class="btn ">Edit address</button>
                                            </div>
                                        </form>
                                        
                                      </div>
                                    </div>
                                  </div>
    
                              </div>
                            </div>
                            
                          </div>
                        </div>
                    <% } %>
                </div>
              <% } else { %>
                
                <h6 class="mb-3">Contact Details</h6>
                <form id="addressForm" style="width: 500px;" method="post" action="/addAddress">
                  <div class="modal-body">
                  
                      <div class="form-group mb-2">
                          <label class="required-label" for="name">Name</label>
                          <input type="text" class="form-control" id="name" name="name" required placeholder="Name">
                      </div>
                      <div class="form-group mb-2">
                          <label for="address">Address:</label>
                          <textarea type="text" class="form-control" id="address" name="address" required rows="3" required placeholder="Address"></textarea>
                          <!-- <input type="text" class="form-control" id="address" name="address" required placeholder="Address"> -->
                      </div>
                      <div class="form-group mb-2">
                          <label for="city">City/Town:</label>
                          <input type="text" class="form-control" id="city" name="city" required placeholder="City/Town">
                      </div>
                      <div class="form-group mb-2">
                          <label for="state">State:</label>
                          <input type="text" class="form-control" id="state" name="state" required placeholder="State">
                      </div>
                      <div class="form-group mb-2">
                          <label for="country">Country:</label>
                          <input type="text" class="form-control" id="country" name="country" required placeholder="Country">
                      </div>
                      <div class="form-group mb-2">
                          <label for="pincode">Pincode:</label>
                          <input type="text" class="form-control" id="pincode" name="pincode" required placeholder="Pincode">
                      </div>
                      <div class="form-group mb-2">
                          <label for="altNumber">Mobile Number:</label>
                          <input type="number" class="form-control" id="altNumber" name="mobileNumber" placeholder="Mobile Number">
                      </div>
                      <!-- <button type="submit" class="btn btn-primary mb-2">Submit</button> -->
                  </div>
                  <div class="modal-footer">
                  <!-- <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> -->
                  <button type="submit" class="btn ">Add address</button>
                  </div>
              </form>

              <% } %>
  
              
            </div>
          </div>
        </div>
        <div class="col-lg-3">

          <div class="card shadow-0 border mb-2">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <p class="mb-2">Total price:</p>
                <p class="mb-2" id="subTotal">₹<%= subtotalPrice.toFixed(2) %></p>
              </div>
              <div class="d-flex justify-content-between">
                <p class="mb-2">Discount:</p>
                <p class="mb-2 text-success"id="discount">-₹<%= couponAmount %>.00</p>
              </div>
              <div class="d-flex justify-content-between">
                <p class="mb-2">Delivery:</p>
                <p class="mb-2" id="deliveryCharge">₹40.00</p>
              </div>
              <hr />
              <div class="d-flex justify-content-between">
                <p class="mb-2">Total price:</p>
                <p class="mb-2 fw-bold" id="total">₹<%= totalPrice.toFixed(2) %></p>
              </div>
              <hr>
              <h6 class="mb-3">Select Payment Method</h6>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="paymentMethod" value="cashOnDelivery" id="cashOnDelivery" checked>
                <label class="form-check-label" for="cashOnDelivery">Cash on Delivery</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="paymentMethod" value="onlinePayment" id="onlinePayment">
                <label class="form-check-label" for="onlinePayment">Online Payment</label>
              </div>
              <div class="mt-3">
                <a id="makePurchaseButton" class="btn w-100 shadow-0 mb-2"> Make Purchase </a>
                <!-- <button id="makePurchaseButton" class="btn w-100 shadow-0 mb-2"> Make Purchase </button> -->

                <!-- <a href="#" class="btn btn-light w-100 border mt-2"> Back to shop </a> -->
              </div>
            </div>
          </div>
            
          
            <div class="card mb-3 border shadow-0">
              <% user.cart.forEach(product => { %>
                <div class="card-body row mb-0">
                  <div class="col-3 mb-0 " >
                      <img style="height: 60px; width: 55px;" src="/<%= product.product.image[0] %>" alt="">
                  </div>
                <div class="col-9">
                  <div class="d-flex">
                      <p style="font-size:small;" class="m-0"><%= product.product.title %></p>
                  </div>
                  <div class="d-flex mb-0">
                      <p style="font-size:small;" class=""><%= product.size %>  </p>
                      <p style="font-size:small;" class="mx-4 text-body-secondary justify-self-center"> X <%= product.quantity %> </p>
                  </div>
              </div>
          </div>
              <% }) %>
            </div>
          
        </div>
        <!-- summary -->
      </div>
    </div>
    <!-- Error Modal -->
    <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="errorModalLabel">Error</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Please choose both an address and a payment method.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <input type="hidden" id="userId" value="<%= user._id %>">
    <div class="modal fade" id="exampleModal1" tabindex="-1" aria-labelledby="exampleModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header border-bottom-0">
                  <button type="button" class="btn-close" data-mdb-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-start text-black p-4">
                  <!-- <h5 class="modal-title text-uppercase mb-5" id="exampleModalLabel">Johnatan Miller</h5> -->
                  <img style="margin-left: 75px; height: 200px; width: 300px;" class="d-flex justify-content-center ml-5" src="/images/Tiny man ordering products online via smartphone.jpg" alt="">
                  <h4 class="mb-5 text-success d-flex justify-content-center m-0" style="color: #35558a;">Thanks for your order</h4>
                  <!-- <p class="mb-0" style="color: #35558a;">Payment summary</p>
                  <hr class="mt-2 mb-4"
                    style="height: 0; background-color: transparent; opacity: .75; border-top: 2px dashed #9e9e9e;"> -->
  
                  <!-- <div class="d-flex justify-content-between">
                    <p class="fw-bold mb-0">Ether Chair(Qty:1)</p>
                    <p class="text-muted mb-0">$1750.00</p>
                  </div>
  
                  <div class="d-flex justify-content-between">
                    <p class="small mb-0">Shipping</p>
                    <p class="small mb-0">$175.00</p>
                  </div>
  
                  <div class="d-flex justify-content-between pb-1">
                    <p class="small">Tax</p>
                    <p class="small">$200.00</p>
                  </div>
  
                  <div class="d-flex justify-content-between">
                    <p class="fw-bold">Total</p>
                    <p class="fw-bold" style="color: #35558a;">$2125.00</p>
                  </div> -->
  
                </div>
                <div class="modal-footer d-flex justify-content-center border-top-0 py-4">
                  <a href="/orderList">
                    <button type="button" class="btn text-white btn-lg mb-1"  style="background-color: #363636;">
                      Track your order
                    </button>
                  </a>

                </div>
              </div>
            </div>
          </div>
  </section>

  

  <%- include('./partials/footer.ejs') %>
  <script>

    function orderList(){
      fetch(`/orderList`,{
            method:"GET",
        }).then(()=>{
           
        })
    }

    function deleteAddress(userId,index){
        fetch(`/deleteAddress?userId=${userId}&index=${index}`,{
            method:"DELETE",
        }).then(()=>{
            window.location.reload()
        })
    }

    function makeDefaultAddress(userId,index){
        fetch(`/makeDefaultAddress?userId=${userId}&index=${index}`,{
            method:"POST",
        }).then(()=>{
            window.location.reload()
        })
    }

  </script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    $(document).ready(function () {
      // Find all card elements
      const cards = document.querySelectorAll('.card[data-index]');
  
      // Add a click event listener to each card
      cards.forEach(function (card) {
        card.addEventListener('click', function () {
          // Get the associated address index from the data-index attribute
          const addressIndex = card.getAttribute('data-index');
          
          // Find the corresponding radio button and trigger a click event on it
          const radioButton = document.getElementById('address' + addressIndex);
          radioButton.click();
        });
      });
    });
  </script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const makePurchaseButton = document.querySelector("#makePurchaseButton");
      const errorModal = new bootstrap.Modal(document.getElementById("errorModal"));
  
      makePurchaseButton.addEventListener("click", function () {
        const selectedAddress = document.querySelector('input[name="selectedAddress"]:checked');
        const selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
  
        if (!selectedAddress || !selectedPaymentMethod) {
          errorModal.show();
        } else {
           // Get the values of the selected radio buttons
          const userId = document.getElementById("userId").value;
          const addressIndex = selectedAddress.value;
          const paymentMethod = selectedPaymentMethod.value;
          const discountText = document.getElementById('discount').textContent;
          const discount = parseFloat(discountText.replace('-₹', ''));
          const totalText = document.getElementById('total').textContent;
          const total = parseFloat(totalText.replace('₹', ''));

          console.log(addressIndex,paymentMethod,userId,discount,total);

          // Prepare the data to send in the request
          const orderData = {
            paymentMethod,
            addressIndex,
            userId,
            discount,
            total,
          };

          // Make an AJAX request to your server
          fetch("/placeOrder", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(orderData),
          })
          .then((response) => response.json())
          .then((data) => {
            // Check if the order placement was successful
            if (data.success) {
              // Show the modal after successful order placement
              $('#exampleModal1').modal('show');
            } else {
              // Handle the case where order placement failed
              console.error("Order placement failed:", data.error);
              // You can show an error message or handle it as needed
            }
          })
            .catch((error) => {
              console.error("Error placing the order:", error);
              // Handle errors here, such as displaying an error message to the user
            });
        }
      });
    });
  </script>












<%- include('./partials/header.ejs') %>
<% let subtotalPrice = 0 %>
<% let totalPrice = 0 %>

<section class=" my-5 d-flex justify-self-center">
    <div class="container ">
      <div class="row d-flex justify-content-center">
        <!-- cart -->
        <div class="col-lg-7 d-flex justify-content-center">
          <div class="card border shadow-1">
            <div class="m-4">
              
              <% if (user.address.length !== 0) { %>
                <div class="row p-0 m-0 ">
                  <% if (user.cart.length === 0) { %>
                      <div class="container-fluid col-10 d-flex">
                        <h3>Your Shopping cart is empty!</h3>
                      </div>
                  <% } else { %>
                      <div class="col-10 p-0">
                          <h5 class="card-title mb-4 ">Select your address</h5>
                      </div>
                      <div class="col-2 d-flex justify-content-end p-0">
                          <!-- <button  class="btn btn-sm m-0 d-flex justify-content-center align-items-center"></button> -->
                          <button style="height: 30px; width: 110px;" type="button" class="btn btn-sm m-0 d-flex justify-content-center align-items-center" data-bs-toggle="modal" data-bs-target="#exampleModal">
                              Add address
                          </button>
                      </div>
  
                      <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                          <div class="modal-dialog">
                            <div class="modal-content">
                              <div class="modal-header">
                                <h1 class="modal-title fs-5" id="exampleModalLabel">Add New Address</h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                              </div>
                              <form id="addressForm" method="post" action="/addAddress">
                                  <div class="modal-body">
                                  
                                      <div class="form-group mb-2">
                                          <!-- <label class="required-label" for="name">Name</label> -->
                                          <input type="text" class="form-control" id="name" name="name" required placeholder="Name">
                                      </div>
                                      <div class="form-group mb-2">
                                          <!-- <label for="address">Address:</label> -->
                                          <input type="text" class="form-control" id="address" name="address" required placeholder="Address">
                                      </div>
                                      <div class="form-group mb-2">
                                          <!-- <label for="city">City/Town:</label> -->
                                          <input type="text" class="form-control" id="city" name="city" required placeholder="City/Town">
                                      </div>
                                      <div class="form-group mb-2">
                                          <!-- <label for="state">State:</label> -->
                                          <input type="text" class="form-control" id="state" name="state" required placeholder="State">
                                      </div>
                                      <div class="form-group mb-2">
                                          <!-- <label for="country">Country:</label> -->
                                          <input type="text" class="form-control" id="country" name="country" required placeholder="Country">
                                      </div>
                                      <div class="form-group mb-2">
                                          <!-- <label for="pincode">Pincode:</label> -->
                                          <input type="text" class="form-control" id="pincode" name="pincode" required placeholder="Pincode">
                                      </div>
                                      <div class="form-group mb-2">
                                          <!-- <label for="altNumber">Mobile Number:</label> -->
                                          <input type="number" class="form-control" id="altNumber" name="mobileNumber" placeholder="Mobile Number">
                                      </div>
                                      <!-- <button type="submit" class="btn btn-primary mb-2">Submit</button> -->
                                  </div>
                                  <div class="modal-footer">
                                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                  <button type="submit" class="btn ">Add address</button>
                                  </div>
                              </form>
                              
                            </div>
                          </div>
                        </div>
                      <!-- Render the cart items here -->
                  <% } %>
                    
                </div>
  
                <div class="row">
                  <h6 class="mb-3">Default Address</h6>
                  <% if (user.address[0]) { %>
                      <div class="col-md-12 mb-3">
                          <div class="card h-100" style="" data-index="<%= 0 %>">
                            <div class="form-check">
                              <input class="form-check-input d-flex mx-1 mt-4" type="radio" name="selectedAddress" value="<%= 0 %>" id="address<%= 0 %>" >
                              <div class="card-body mx-3">
                              
                                <h5 class="card-title"><%= user.address[0].name%></h5>
                                <h6 class="card-subtitle mb-2 text-body-secondary"><%= user.address[0].mobileNumber %></h6>
                                <p class="card-text"><%= user.address[0].address %>, <%= user.address[0].city %>, <%= user.address[0].state %>, <%= user.address[0].country %>, <%= user.address[0].pincode %></p>
                                <a href="#" data-bs-toggle="modal" data-bs-target="#editAddressModal<%= user.address[0]._id %>" class="btn2 card-link">Edit</a>
                                <a href="#" onclick="deleteAddress('<%= user._id %>','<%= 0 %>')" class="btn2 card-link">Delete</a>
                                <!-- <a href="#" class="btn2 card-link">Set as default</a> -->
    
                                <div class="modal fade" id="editAddressModal<%= user.address[0]._id %>" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                    <div class="modal-dialog">
                                      <div class="modal-content">
                                        <div class="modal-header">
                                          <h1 class="modal-title fs-5" id="exampleModalLabel">Edit Address</h1>
                                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <form id="addressForm" method="post" action="/editAddress?userId=<%= user._id %>&index=<%= 0 %>">
                                            <div class="modal-body">
                                            
                                                <div class="form-group mb-2">
                                                    <!-- <label class="required-label" for="name">Name</label> -->
                                                    <input type="text" class="form-control" id="name" name="name" required placeholder="Name" value="<%= user.address[0].name %>">
                                                </div>
                                                <div class="form-group mb-2">
                                                    <!-- <label for="address">Address:</label> -->
                                                    <input type="text" class="form-control" id="address" name="address" required placeholder="Address" value="<%= user.address[0].address %>">
                                                </div>
                                                <div class="form-group mb-2">
                                                    <!-- <label for="city">City/Town:</label> -->
                                                    <input type="text" class="form-control" id="city" name="city" required placeholder="City/Town" value="<%= user.address[0].city %>">
                                                </div>
                                                <div class="form-group mb-2">
                                                    <!-- <label for="state">State:</label> -->
                                                    <input type="text" class="form-control" id="state" name="state" required placeholder="State" value="<%= user.address[0].state %>">
                                                </div>
                                                <div class="form-group mb-2">
                                                    <!-- <label for="country">Country:</label> -->
                                                    <input type="text" class="form-control" id="country" name="country" required placeholder="Country" value="<%= user.address[0].country %>">
                                                </div>
                                                <div class="form-group mb-2">
                                                    <!-- <label for="pincode">Pincode:</label> -->
                                                    <input type="text" class="form-control" id="pincode" name="pincode" required placeholder="Pincode" value="<%= user.address[0].pincode %>">
                                                </div>
                                                <div class="form-group mb-2">
                                                    <!-- <label for="altNumber">Mobile Number:</label> -->
                                                    <input type="number" class="form-control" id="altNumber" name="mobileNumber" placeholder="Mobile Number" value="<%= user.address[0].mobileNumber %>">
                                                </div>
                                                <!-- <button type="submit" class="btn btn-primary mb-2">Submit</button> -->
                                            </div>
                                            <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                            <button type="submit" class="btn ">Edit address</button>
                                            </div>
                                        </form>
                                        
                                      </div>
                                    </div>
                                  </div>
    
                              </div>
                            </div>
                            
                            
                          </div>
                        </div>
                  <% } else { %>
                    
                  <% } %>
  
                  <h6 class="mb-3">Other Address</h6>
                    <% for( let index = 1; index < user.address.length; index++ ) { %>
                      <div class="col-md-12 mb-2">
                          <div class="card h-100" style="" data-index="<%= index %>">
                            <div class="form-check">
                              <input class="form-check-input d-flex mx-1 mt-4" type="radio" name="selectedAddress" value="<%= index %>" id="address<%= index %>" >
                              <div class="form-check-label card-body mx-3" for="address<%= index %>">
                                <h5 class="card-title"><%= user.address[index].name%></h5>
                                <h6 class="card-subtitle mb-2 text-body-secondary"><%= user.address[index].mobileNumber %></h6>
                                <p class="card-text"><%= user.address[index].address %>, <%= user.address[index].city %>, <%= user.address[index].state %>, <%= user.address[index].country %>, <%= user.address[index].pincode %></p>
                                <a href="#" data-bs-toggle="modal" data-bs-target="#editAddressModal<%= user.address[index]._id %>" class="btn2 card-link">Edit</a>
                                <!-- <button class="btn2 card-link">Edit</button> -->
                                <a href="#" onclick="deleteAddress('<%= user._id %>','<%= index %>')" class="btn2 card-link">Delete</a>
                                <a href="#" onclick="makeDefaultAddress('<%= user._id %>','<%= index %>')" class="btn2 card-link">Set as default</a>
    
                                <div class="modal fade" id="editAddressModal<%= user.address[index]._id %>" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                    <div class="modal-dialog">
                                      <div class="modal-content">
                                        <div class="modal-header">
                                          <h1 class="modal-title fs-5" id="exampleModalLabel">Edit Address</h1>
                                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <form id="addressForm" method="post" action="/editAddress?userId=<%= user._id %>&index=<%= index %>">
                                            <div class="modal-body">
                                            
                                                <div class="form-group mb-2">
                                                    <!-- <label class="required-label" for="name">Name</label> -->
                                                    <input type="text" class="form-control" id="name" name="name" required placeholder="Name" value="<%= user.address[index].name %>">
                                                </div>
                                                <div class="form-group mb-2">
                                                    <!-- <label for="address">Address:</label> -->
                                                    <input type="text" class="form-control" id="address" name="address" required placeholder="Address" value="<%= user.address[index].address %>">
                                                </div>
                                                <div class="form-group mb-2">
                                                    <!-- <label for="city">City/Town:</label> -->
                                                    <input type="text" class="form-control" id="city" name="city" required placeholder="City/Town" value="<%= user.address[index].city %>">
                                                </div>
                                                <div class="form-group mb-2">
                                                    <!-- <label for="state">State:</label> -->
                                                    <input type="text" class="form-control" id="state" name="state" required placeholder="State" value="<%= user.address[index].state %>">
                                                </div>
                                                <div class="form-group mb-2">
                                                    <!-- <label for="country">Country:</label> -->
                                                    <input type="text" class="form-control" id="country" name="country" required placeholder="Country" value="<%= user.address[index].country %>">
                                                </div>
                                                <div class="form-group mb-2">
                                                    <!-- <label for="pincode">Pincode:</label> -->
                                                    <input type="text" class="form-control" id="pincode" name="pincode" required placeholder="Pincode" value="<%= user.address[index].pincode %>">
                                                </div>
                                                <div class="form-group mb-2">
                                                    <!-- <label for="altNumber">Mobile Number:</label> -->
                                                    <input type="number" class="form-control" id="altNumber" name="mobileNumber" placeholder="Mobile Number" value="<%= user.address[index].mobileNumber %>">
                                                </div>
                                                <!-- <button type="submit" class="btn btn-primary mb-2">Submit</button> -->
                                            </div>
                                            <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                            <button type="submit" class="btn ">Edit address</button>
                                            </div>
                                        </form>
                                        
                                      </div>
                                    </div>
                                  </div>
    
                              </div>
                            </div>
                            
                          </div>
                        </div>
                    <% } %>
                </div>
              <% } else { %>
                
                <h6 class="mb-3">Contact Details</h6>
                <form id="addressForm" style="width: 500px;" method="post" action="/addAddress">
                  <div class="modal-body">
                  
                      <div class="form-group mb-2">
                          <label class="required-label" for="name">Name</label>
                          <input type="text" class="form-control" id="name" name="name" required placeholder="Name">
                      </div>
                      <div class="form-group mb-2">
                          <label for="address">Address:</label>
                          <textarea type="text" class="form-control" id="address" name="address" required rows="3" required placeholder="Address"></textarea>
                          <!-- <input type="text" class="form-control" id="address" name="address" required placeholder="Address"> -->
                      </div>
                      <div class="form-group mb-2">
                          <label for="city">City/Town:</label>
                          <input type="text" class="form-control" id="city" name="city" required placeholder="City/Town">
                      </div>
                      <div class="form-group mb-2">
                          <label for="state">State:</label>
                          <input type="text" class="form-control" id="state" name="state" required placeholder="State">
                      </div>
                      <div class="form-group mb-2">
                          <label for="country">Country:</label>
                          <input type="text" class="form-control" id="country" name="country" required placeholder="Country">
                      </div>
                      <div class="form-group mb-2">
                          <label for="pincode">Pincode:</label>
                          <input type="text" class="form-control" id="pincode" name="pincode" required placeholder="Pincode">
                      </div>
                      <div class="form-group mb-2">
                          <label for="altNumber">Mobile Number:</label>
                          <input type="number" class="form-control" id="altNumber" name="mobileNumber" placeholder="Mobile Number">
                      </div>
                      <!-- <button type="submit" class="btn btn-primary mb-2">Submit</button> -->
                  </div>
                  <div class="modal-footer">
                  <!-- <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> -->
                  <button type="submit" class="btn ">Add address</button>
                  </div>
              </form>

              <% } %>
  
              
            </div>
          </div>
        </div>
        <div class="col-lg-3">

          <div class="card shadow-0 border mb-2">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <p class="mb-2">Total price:</p>
                <p class="mb-2" id="subTotal">₹<%= subtotalPrice.toFixed(2) %></p>
              </div>
              <div class="d-flex justify-content-between">
                <p class="mb-2">Discount:</p>
                <p class="mb-2 text-success"id="discount">-₹00.00</p>
              </div>
              <div class="d-flex justify-content-between">
                <p class="mb-2">Delivery:</p>
                <p class="mb-2" id="deliveryCharge">₹40.00</p>
              </div>
              <hr />
              <% totalPrice = subtotalPrice + 40 %>
              <div class="d-flex justify-content-between">
                <p class="mb-2">Total price:</p>
                <p class="mb-2 fw-bold" id="total">₹<%= totalPrice.toFixed(2) %></p>
              </div>
              <hr>
              <h6 class="mb-3">Select Payment Method</h6>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="paymentMethod" value="cashOnDelivery" id="cashOnDelivery" checked>
                <label class="form-check-label" for="cashOnDelivery">Cash on Delivery</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="paymentMethod" value="onlinePayment" id="onlinePayment">
                <label class="form-check-label" for="onlinePayment">Online Payment</label>
              </div>
              <div class="mt-3">
                <a id="makePurchaseButton" class="btn w-100 shadow-0 mb-2"> Make Purchase </a>
                <!-- <button id="makePurchaseButton" class="btn w-100 shadow-0 mb-2"> Make Purchase </button> -->

                <!-- <a href="#" class="btn btn-light w-100 border mt-2"> Back to shop </a> -->
              </div>
            </div>
          </div>
            
          
            <div class="card mb-3 border shadow-0">
              <% user.cart.forEach(product => { %>
                <div class="card-body row mb-0">
                  <div class="col-3 mb-0 " >
                      <img style="height: 60px; width: 55px;" src="/<%= product.product.image[0] %>" alt="">
                  </div>
                <div class="col-9">
                  <div class="d-flex">
                      <p style="font-size:small;" class="m-0"><%= product.product.title %></p>
                  </div>
                  <div class="d-flex mb-0">
                      <p style="font-size:small;" class=""><%= product.size %>  </p>
                      <p style="font-size:small;" class="mx-4 text-body-secondary justify-self-center"> X <%= product.quantity %> </p>
                  </div>
              </div>
          </div>
              <% }) %>
            </div>
          
        </div>
        <!-- summary -->
      </div>
    </div>
    <!-- Error Modal -->
    <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="errorModalLabel">Error</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Please choose both an address and a payment method.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <input type="hidden" id="userId" value="<%= user._id %>">
  </section>

  <!-- <section class="vh-100" style="background-color: #35558a;">
    <div class="container py-5 h-100">
      <div class="row d-flex justify-content-center align-items-center h-100 text-center">
        <div class="col"> -->
          <!-- Button trigger modal -->
          <!-- <button type="button" class="btn btn-light btn-lg" data-mdb-toggle="modal"
            data-mdb-target="#exampleModal">
            <i class="fas fa-info me-2"></i> Get information
          </button> -->
  
          <!-- Modal -->
          <div class="modal fade" id="exampleModal1" tabindex="-1" aria-labelledby="exampleModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header border-bottom-0">
                  <button type="button" class="btn-close" data-mdb-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-start text-black p-4">
                  <!-- <h5 class="modal-title text-uppercase mb-5" id="exampleModalLabel">Johnatan Miller</h5> -->
                  <img style="margin-left: 75px; height: 200px; width: 300px;" class="d-flex justify-content-center ml-5" src="/images/Tiny man ordering products online via smartphone.jpg" alt="">
                  <h4 class="mb-5 text-success d-flex justify-content-center m-0" style="color: #35558a;">Thanks for your order</h4>
                  <!-- <p class="mb-0" style="color: #35558a;">Payment summary</p>
                  <hr class="mt-2 mb-4"
                    style="height: 0; background-color: transparent; opacity: .75; border-top: 2px dashed #9e9e9e;"> -->
  
                  <!-- <div class="d-flex justify-content-between">
                    <p class="fw-bold mb-0">Ether Chair(Qty:1)</p>
                    <p class="text-muted mb-0">$1750.00</p>
                  </div>
  
                  <div class="d-flex justify-content-between">
                    <p class="small mb-0">Shipping</p>
                    <p class="small mb-0">$175.00</p>
                  </div>
  
                  <div class="d-flex justify-content-between pb-1">
                    <p class="small">Tax</p>
                    <p class="small">$200.00</p>
                  </div>
  
                  <div class="d-flex justify-content-between">
                    <p class="fw-bold">Total</p>
                    <p class="fw-bold" style="color: #35558a;">$2125.00</p>
                  </div> -->
  
                </div>
                <div class="modal-footer d-flex justify-content-center border-top-0 py-4">
                  <a href="/orderList">
                    <button type="button" class="btn text-white btn-lg mb-1"  style="background-color: #363636;">
                      Track your order
                    </button>
                  </a>

                </div>
              </div>
            </div>
          </div>
  
        <!-- </div>
      </div>
    </div>
  </section> -->
  

  <%- include('./partials/footer.ejs') %>
  <script>

    function orderList(){
      fetch(`/orderList`,{
            method:"GET",
        }).then(()=>{
           
        })
    }

    function deleteAddress(userId,index){
        fetch(`/deleteAddress?userId=${userId}&index=${index}`,{
            method:"DELETE",
        }).then(()=>{
            window.location.reload()
        })
    }

    function makeDefaultAddress(userId,index){
        fetch(`/makeDefaultAddress?userId=${userId}&index=${index}`,{
            method:"POST",
        }).then(()=>{
            window.location.reload()
        })
    }

  </script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    $(document).ready(function () {
      // Find all card elements
      const cards = document.querySelectorAll('.card[data-index]');
  
      // Add a click event listener to each card
      cards.forEach(function (card) {
        card.addEventListener('click', function () {
          // Get the associated address index from the data-index attribute
          const addressIndex = card.getAttribute('data-index');
          
          // Find the corresponding radio button and trigger a click event on it
          const radioButton = document.getElementById('address' + addressIndex);
          radioButton.click();
        });
      });
    });
  </script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const makePurchaseButton = document.querySelector("#makePurchaseButton");
      const errorModal = new bootstrap.Modal(document.getElementById("errorModal"));
  
      makePurchaseButton.addEventListener("click", function () {
        const selectedAddress = document.querySelector('input[name="selectedAddress"]:checked');
        const selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
  
        if (!selectedAddress || !selectedPaymentMethod) {
          errorModal.show();
        } else {
           // Get the values of the selected radio buttons
          const userId = document.getElementById("userId").value;
          const addressIndex = selectedAddress.value;
          const paymentMethod = selectedPaymentMethod.value;

          console.log(addressIndex,paymentMethod,userId);

          // Prepare the data to send in the request
          const orderData = {
            paymentMethod,
            addressIndex,
            userId,
          };

          // Make an AJAX request to your server
          fetch("/placeOrder", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(orderData),
          })
          .then((response) => response.json())
          .then((data) => {
            // Check if the order placement was successful
            if (data.success) {
              // Show the modal after successful order placement
              $('#exampleModal1').modal('show');
            } else {
              // Handle the case where order placement failed
              console.error("Order placement failed:", data.error);
              // You can show an error message or handle it as needed
            }
          })
            .catch((error) => {
              console.error("Error placing the order:", error);
              // Handle errors here, such as displaying an error message to the user
            });
        }
      });
    });
  </script>